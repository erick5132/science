<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>植物かんさつアプリ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #a8e6cf, #dcedc1);
            min-height: 100vh;
            padding: 10px;
            font-size: 16px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .step-container {
            margin-bottom: 30px;
        }

        .step-header {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 5px solid #4CAF50;
        }

        .step-number {
            background: #4CAF50;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
            margin-right: 15px;
        }

        .step-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #2e7d32;
            display: inline-block;
            vertical-align: middle;
        }

        .step-content {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 2px dashed #4CAF50;
        }

        .info-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }

        .form-group input, .form-group select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.1em;
        }

        .form-group input:focus, .form-group select:focus {
            border-color: #4CAF50;
            outline: none;
        }

        .photo-section {
            margin-bottom: 30px;
        }

        .photo-type {
            background: white;
            border: 3px solid #4CAF50;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .photo-type h3 {
            color: #2e7d32;
            font-size: 1.4em;
            margin-bottom: 15px;
            text-align: center;
        }

        .photo-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .photo-btn, .measure-btn {
            padding: 15px 25px;
            font-size: 1.2em;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .photo-btn {
            background: #2196F3;
            color: white;
        }

        .photo-btn:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }

        .measure-btn {
            background: #FF9800;
            color: white;
        }

        .measure-btn:hover {
            background: #F57C00;
            transform: translateY(-2px);
        }

        .measure-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .photo-preview {
            text-align: center;
            margin-top: 15px;
        }

        .photo-preview img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .camera-section {
            display: none;
            background: #f0f8ff;
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
        }

        .camera-container {
            text-align: center;
        }

        #cameraVideo {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .camera-controls {
            margin-top: 15px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .capture-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.2em;
        }

        .capture-btn:hover {
            background: #cc0000;
        }

        .close-camera-btn {
            background: #666;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.2em;
        }

        .measurement-area {
            display: none;
            background: #fff3cd;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        .measurement-instructions {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .measurement-instructions h4 {
            color: #2e7d32;
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        .measurement-instructions p {
            font-size: 1.1em;
            color: #333;
        }

        .reference-setup {
            background: #ffebee;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #f44336;
        }

        .reference-input {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .reference-input label {
            font-weight: bold;
            font-size: 1.2em;
        }

        .reference-input input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1.1em;
            width: 100px;
        }

        .canvas-container {
            border: 3px solid #4CAF50;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            text-align: center;
        }

        #measurementCanvas {
            max-width: 100%;
            cursor: crosshair;
        }

        .measurement-result {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .measurement-value {
            font-size: 2em;
            font-weight: bold;
            color: #2e7d32;
            margin: 10px 0;
        }

        .observation-section {
            margin-top: 30px;
        }

        .observation-form {
            background: #f0f8ff;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #2196F3;
        }

        .observation-form h3 {
            color: #1976D2;
            font-size: 1.4em;
            margin-bottom: 15px;
        }

        .observation-form textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.1em;
            font-family: inherit;
            resize: vertical;
        }

        .observation-form textarea:focus {
            border-color: #2196F3;
            outline: none;
        }

        .print-section {
            margin-top: 30px;
            text-align: center;
        }

        .print-btn {
            background: #9C27B0;
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 1.3em;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .print-btn:hover {
            background: #7B1FA2;
            transform: translateY(-2px);
        }

        .print-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .print-content, .print-content * {
                visibility: visible;
            }
            .print-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                font-size: 12px;
            }
        }

        .print-content {
            display: none;
            background: white;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            font-size: 12px;
            line-height: 1.3;
        }

        .print-header {
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .print-header h1 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .print-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
            font-size: 11px;
        }

        .print-photos {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .print-photo {
            text-align: center;
        }

        .print-photo h3 {
            font-size: 13px;
            margin-bottom: 8px;
        }

        .print-photo img {
            max-width: 100%;
            max-height: 180px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .print-measurements {
            margin-bottom: 15px;
        }

        .print-measurements h3 {
            font-size: 13px;
            margin-bottom: 8px;
        }

        .print-measurements-content {
            font-size: 11px;
            line-height: 1.4;
        }

        .print-observation {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            min-height: 80px;
            font-size: 11px;
            line-height: 1.4;
        }

        .print-observation h3 {
            font-size: 13px;
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .info-form {
                grid-template-columns: 1fr;
            }
            
            .photo-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .reference-input {
                flex-direction: column;
                text-align: center;
            }
            
            .print-photos {
                grid-template-columns: 1fr;
            }
        }

        .measurement-results {
            background: #e8f5e9;
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
            border: 2px solid #4CAF50;
        }

        .measurement-results h4 {
            color: #2e7d32;
            margin-bottom: 15px;
            text-align: center;
        }

        .result-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .result-name {
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }

        .result-detail {
            color: #666;
            font-size: 0.9em;
        }

        .result-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #2e7d32;
        }

        .delete-result {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .measurement-controls {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .measurement-controls h4 {
            color: #1976D2;
            margin-bottom: 15px;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .add-measurement-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1.1em;
        }

        .finish-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1.1em;
        }

        .clear-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1.1em;
        }

        .growth-section {
            margin-top: 30px;
        }

        .growth-form {
            background: #fff3e0;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #FF9800;
        }

        .growth-form h3 {
            color: #F57C00;
            font-size: 1.4em;
            margin-bottom: 15px;
        }

        .growth-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .growth-btn {
            background: #FF9800;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        .growth-btn:hover {
            background: #F57C00;
            transform: translateY(-2px);
        }

        .growth-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .growth-history {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
            border: 2px solid #FF9800;
            max-height: 400px;
            overflow-y: auto;
        }

        .growth-record {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border-left: 4px solid #FF9800;
        }

        .growth-date {
            font-weight: bold;
            color: #F57C00;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .growth-measurements {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .growth-measurement {
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .growth-value {
            font-weight: bold;
            color: #2e7d32;
            font-size: 1.1em;
        }

        .growth-comparison {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border: 2px solid #4CAF50;
        }

        .growth-comparison h4 {
            color: #2e7d32;
            margin-bottom: 10px;
            text-align: center;
        }

        .comparison-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }

        .comparison-item:last-child {
            border-bottom: none;
        }

        .comparison-label {
            font-weight: bold;
            color: #333;
        }

        .comparison-change {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9em;
        }

        .growth-positive {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .growth-negative {
            background: #ffcdd2;
            color: #d32f2f;
        }

        .growth-neutral {
            background: #e0e0e0;
            color: #666;
        }

        .delete-record {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.8em;
            margin-top: 8px;
        }

        .print-growth {
            margin-bottom: 15px;
        }

        .print-growth h3 {
            font-size: 13px;
            margin-bottom: 8px;
        }

        .print-growth-content {
            font-size: 11px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌱 植物かんさつアプリ</h1>
            <p>植物をかんさつして、きろくしよう！</p>
        </div>

        <div class="main-content">
            <!-- ステップ1: 基本情報 -->
            <div class="step-container">
                <div class="step-header">
                    <span class="step-number">1</span>
                    <span class="step-title">植物の情報を書こう</span>
                </div>
                <div class="step-content">
                    <div class="info-form">
                        <div class="form-group">
                            <label for="plantName">植物の名前</label>
                            <input type="text" id="plantName" placeholder="例：ひまわり">
                        </div>
                        <div class="form-group">
                            <label for="observationDate">かんさつした日</label>
                            <input type="date" id="observationDate">
                        </div>
                        <div class="form-group">
                            <label for="weather">天気</label>
                            <select id="weather">
                                <option value="">えらんでください</option>
                                <option value="晴れ">☀️ 晴れ</option>
                                <option value="曇り">☁️ 曇り</option>
                                <option value="雨">🌧️ 雨</option>
                                <option value="雪">❄️ 雪</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ステップ2: 写真撮影 -->
            <div class="step-container">
                <div class="step-header">
                    <span class="step-number">2</span>
                    <span class="step-title">植物の写真をとろう</span>
                </div>
                <div class="step-content">
                    <div class="photo-section">
                        <!-- 葉・花の写真 -->
                        <div class="photo-type">
                            <h3>🍃 葉っぱや花の写真</h3>
                            <p style="text-align: center; margin-bottom: 15px;">葉っぱや花と一緒に、ものさしも写してね</p>
                            <div class="photo-buttons">
                                <input type="file" id="leafImageInput" accept="image/*" style="display: none;">
                                <button class="photo-btn" onclick="document.getElementById('leafImageInput').click()">
                                    📁 写真をえらぶ
                                </button>
                                <button class="photo-btn" onclick="startCamera('leaf')">
                                    📸 カメラでとる
                                </button>
                            </div>
                            <div class="photo-preview" id="leafPhotoPreview"></div>
                            
                            <div style="text-align: center; margin-top: 15px;">
                                <button class="measure-btn" id="leafMeasureBtn" onclick="startMeasurement('leaf')" disabled>
                                    📏 大きさをはかる
                                </button>
                            </div>
                            
                            <!-- 測定結果一覧 -->
                            <div class="measurement-results" id="leafMeasurementResults" style="display: none;">
                                <h4>📊 測定結果</h4>
                                <div id="leafResultsList"></div>
                            </div>
                        </div>

                        <!-- 茎の写真 -->
                        <div class="photo-type">
                            <h3>🌿 茎の写真</h3>
                            <p style="text-align: center; margin-bottom: 15px;">茎の全体と一緒に、ものさしも写してね</p>
                            <div class="photo-buttons">
                                <input type="file" id="stemImageInput" accept="image/*" style="display: none;">
                                <button class="photo-btn" onclick="document.getElementById('stemImageInput').click()">
                                    📁 写真をえらぶ
                                </button>
                                <button class="photo-btn" onclick="startCamera('stem')">
                                    📸 カメラでとる
                                </button>
                            </div>
                            <div class="photo-preview" id="stemPhotoPreview"></div>
                            <div style="text-align: center; margin-top: 15px;">
                                <button class="measure-btn" id="stemMeasureBtn" onclick="startMeasurement('stem')" disabled>
                                    📏 高さをはかる
                                </button>
                            </div>
                            
                            <!-- 測定結果一覧 -->
                            <div class="measurement-results" id="stemMeasurementResults" style="display: none;">
                                <h4>📊 測定結果</h4>
                                <div id="stemResultsList"></div>
                            </div>
                        </div>
                    </div>

                    <!-- カメラセクション -->
                    <div class="camera-section" id="cameraSection">
                        <h3>📸 カメラで撮影</h3>
                        <div class="camera-container">
                            <video id="cameraVideo" autoplay playsinline></video>
                            <canvas id="captureCanvas" style="display: none;"></canvas>
                        </div>
                        <div class="camera-controls">
                            <button class="capture-btn" onclick="capturePhoto()">📷 しゃしんをとる</button>
                            <button class="close-camera-btn" onclick="stopCamera()">❌ カメラをとじる</button>
                        </div>
                    </div>

                    <!-- 測定エリア -->
                    <div class="measurement-area" id="measurementArea">
                        <div class="measurement-instructions">
                            <h4 id="measurementTitle">測定中...</h4>
                            <p id="measurementInstruction">指示が表示されます</p>
                        </div>

                        <div class="reference-setup" id="referenceSetup">
                            <h4 style="text-align: center; margin-bottom: 15px;">ものさしの長さを教えて</h4>
                            <div class="reference-input">
                                <label>ものさしの長さ:</label>
                                <input type="number" id="referenceLength" value="10" min="1" max="100">
                                <select id="unit">
                                    <option value="cm">cm</option>
                                    <option value="mm">mm</option>
                                </select>
                            </div>
                        </div>

                        <div class="canvas-container">
                            <canvas id="measurementCanvas"></canvas>
                        </div>

                        <div class="measurement-result" id="measurementResult" style="display: none;">
                            <h4 id="resultTitle">測定結果</h4>
                            <div class="measurement-value" id="resultValue">-- cm</div>
                            
                            <div class="measurement-controls">
                                <h4>測定を続けますか？</h4>
                                <div class="control-buttons">
                                    <button class="add-measurement-btn" onclick="addAnotherMeasurement()">➕ 別の場所も測る</button>
                                    <button class="finish-btn" onclick="finishAllMeasurements()">✅ 測定完了</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ステップ3: 観察記録 -->
            <div class="step-container">
                <div class="step-header">
                    <span class="step-number">3</span>
                    <span class="step-title">気づいたことを書こう</span>
                </div>
                <div class="step-content">
                    <div class="observation-section">
                        <div class="observation-form">
                            <h3>📝 かんさつきろく</h3>
                            <p style="margin-bottom: 15px;">植物を見て、気づいたことや思ったことを書いてね</p>
                            <textarea id="observationText" placeholder="例：葉っぱが大きくなっていた。花がきれいに咲いていた。前よりも背が高くなった。"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ステップ3.5: 成長記録 -->
            <div class="step-container">
                <div class="step-header">
                    <span class="step-number">📈</span>
                    <span class="step-title">成長をきろくしよう</span>
                </div>
                <div class="step-content">
                    <div class="growth-section">
                        <div class="growth-form">
                            <h3>🌱 成長きろく</h3>
                            <p style="margin-bottom: 15px;">今日の測定を保存して、植物の成長を記録しよう！</p>
                            <div class="growth-controls">
                                <button class="growth-btn" id="saveGrowthBtn" onclick="saveGrowthRecord()" disabled>
                                    💾 今日の記録を保存
                                </button>
                                <button class="growth-btn" onclick="showGrowthHistory()">
                                    📊 成長履歴を見る
                                </button>
                                <button class="growth-btn" onclick="clearGrowthHistory()">
                                    🗑️ 履歴をクリア
                                </button>
                            </div>
                            
                            <div class="growth-history" id="growthHistory" style="display: none;">
                                <h4 style="text-align: center; margin-bottom: 15px; color: #F57C00;">📈 成長履歴</h4>
                                <div id="growthRecords"></div>
                            </div>
                            
                            <div class="growth-comparison" id="growthComparison" style="display: none;">
                                <h4>📊 前回との比較</h4>
                                <div id="comparisonResults"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ステップ4: 印刷 -->
            <div class="step-container">
                <div class="step-header">
                    <span class="step-number">4</span>
                    <span class="step-title">かんさつきろくを印刷しよう</span>
                </div>
                <div class="step-content">
                    <div class="print-section">
                        <p style="font-size: 1.2em; margin-bottom: 20px;">すべて入力したら、印刷ボタンを押してね</p>
                        <button class="print-btn" id="printBtn" onclick="printRecord()" disabled>
                            🖨️ かんさつきろくを印刷する
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 印刷用コンテンツ -->
    <div class="print-content" id="printContent">
        <div class="print-header">
            <h1>🌱 植物かんさつきろく</h1>
        </div>
        
        <div class="print-info">
            <div><strong>植物の名前:</strong> <span id="printPlantName">-</span></div>
            <div><strong>かんさつした日:</strong> <span id="printDate">-</span></div>
            <div><strong>天気:</strong> <span id="printWeather">-</span></div>
        </div>

        <div class="print-photos">
            <div class="print-photo">
                <h3>🍃 葉っぱ・花の写真</h3>
                <div id="printLeafPhoto">写真がありません</div>
            </div>
            <div class="print-photo">
                <h3>🌿 茎の写真</h3>
                <div id="printStemPhoto">写真がありません</div>
            </div>
        </div>

        <div class="print-measurements">
            <h3>📏 測定結果</h3>
            <div class="print-measurements-content" id="printMeasurements">測定結果がありません</div>
        </div>

        <div class="print-growth">
            <h3>📈 成長記録</h3>
            <div class="print-growth-content" id="printGrowthRecord">成長記録がありません</div>
        </div>

        <div>
            <h3>📝 かんさつきろく</h3>
            <div class="print-observation" id="printObservation">記録がありません</div>
        </div>
    </div>

    <script>
        // グローバル変数
        let currentPhotoType = '';
        let cameraStream = null;
        let canvas, ctx;
        let currentImage = null;
        let measurementStep = 0; // 0: 基準線, 1: 測定線
        let referencePoints = [];
        let measurementPoints = [];
        let referencePixels = 0;

        let photos = {
            leaf: null,
            stem: null
        };

        let leafMeasurements = [];
        let stemMeasurements = [];

        // 測定マーカー保存用
        let photoAnnotations = {
            leaf: [],
            stem: []
        };

        // 色とインデックス管理
        const markerColors = [
            '#FF4444', '#4CAF50', '#2196F3', '#FF9800', 
            '#9C27B0', '#00BCD4', '#795548', '#607D8B'
        ];

        // 成長記録用変数
        let growthRecords = [];

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            // 今日の日付を設定
            document.getElementById('observationDate').value = new Date().toISOString().split('T')[0];
            
            // ファイル入力のイベントリスナー
            document.getElementById('leafImageInput').addEventListener('change', function(e) {
                handleImageUpload(e, 'leaf');
            });
            
            document.getElementById('stemImageInput').addEventListener('change', function(e) {
                handleImageUpload(e, 'stem');
            });

            // ローカルストレージから成長記録を読み込み
            loadGrowthRecords();

            // 入力チェック
            setInterval(checkFormCompletion, 1000);
        });

        // 画像アップロード処理
        function handleImageUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                photos[type] = e.target.result;
                displayPhoto(type, e.target.result);
                document.getElementById(type + 'MeasureBtn').disabled = false;
            };
            reader.readAsDataURL(file);
        }

        // 写真表示
        function displayPhoto(type, src) {
            const preview = document.getElementById(type + 'PhotoPreview');
            preview.innerHTML = `<img src="${src}" alt="${type}の写真">`;
        }

        // カメラ開始
        async function startCamera(type) {
            currentPhotoType = type;
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('cameraVideo');
                video.srcObject = cameraStream;
                
                document.getElementById('cameraSection').style.display = 'block';
                video.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                alert('カメラが使えません。写真をえらんでください。');
                console.error('Camera error:', error);
            }
        }

        // カメラ停止
        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('cameraSection').style.display = 'none';
        }

        // 写真撮影
        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const captureCanvas = document.getElementById('captureCanvas');
            const captureCtx = captureCanvas.getContext('2d');
            
            captureCanvas.width = video.videoWidth;
            captureCanvas.height = video.videoHeight;
            
            captureCtx.drawImage(video, 0, 0);
            
            const photoData = captureCanvas.toDataURL('image/jpeg', 0.8);
            photos[currentPhotoType] = photoData;
            displayPhoto(currentPhotoType, photoData);
            
            document.getElementById(currentPhotoType + 'MeasureBtn').disabled = false;
            stopCamera();
        }

        // 測定開始
        function startMeasurement(type) {
            currentPhotoType = type;
            currentImage = new Image();
            currentImage.onload = function() {
                setupMeasurementCanvas();
                document.getElementById('measurementArea').style.display = 'block';
                updateMeasurementInstructions();
                document.getElementById('measurementArea').scrollIntoView({ behavior: 'smooth' });
            };
            currentImage.src = photos[type];
        }

        // 測定キャンバス設定
        function setupMeasurementCanvas() {
            canvas = document.getElementById('measurementCanvas');
            ctx = canvas.getContext('2d');
            
            const maxWidth = 600;
            const maxHeight = 400;
            let { width, height } = currentImage;
            
            if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
            }
            if (height > maxHeight) {
                width = (width * maxHeight) / height;
                height = maxHeight;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            measurementStep = 0;
            referencePoints = [];
            measurementPoints = [];
            
            drawCanvas();
            canvas.addEventListener('click', handleCanvasClick);
        }

        // キャンバス描画
        function drawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
            
            // 基準線を描画
            if (referencePoints.length === 2) {
                drawLine(referencePoints[0], referencePoints[1], '#ff4444', 4);
                drawLabel(referencePoints[0], referencePoints[1], 'ものさし', '#ff4444');
            } else if (referencePoints.length === 1) {
                drawPoint(referencePoints[0], '#ff4444');
            }
            
            // 測定線を描画
            if (measurementPoints.length === 2) {
                const currentIndex = photoAnnotations[currentPhotoType].length + 1;
                const color = markerColors[(currentIndex - 1) % markerColors.length];
                drawLine(measurementPoints[0], measurementPoints[1], color, 4);
                drawIndexLabel(measurementPoints[0], measurementPoints[1], currentIndex, color);
            } else if (measurementPoints.length === 1) {
                const currentIndex = photoAnnotations[currentPhotoType].length + 1;
                const color = markerColors[(currentIndex - 1) % markerColors.length];
                drawPoint(measurementPoints[0], color);
            }
        }

        // 線を描画
        function drawLine(point1, point2, color, width) {
            ctx.strokeStyle = color;
            ctx.lineWidth = width;
            ctx.beginPath();
            ctx.moveTo(point1.x, point1.y);
            ctx.lineTo(point2.x, point2.y);
            ctx.stroke();
            
            drawPoint(point1, color);
            drawPoint(point2, color);
        }

        // 点を描画
        function drawPoint(point, color) {
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(point.x, point.y, 8, 0, 2 * Math.PI);
            ctx.fill();
            
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 3;
            ctx.stroke();
        }

        // ラベルを描画
        function drawLabel(point1, point2, text, color) {
            const midX = (point1.x + point2.x) / 2;
            const midY = (point1.y + point2.y) / 2;
            
            ctx.fillStyle = color;
            ctx.font = 'bold 16px Arial';
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 4;
            ctx.strokeText(text, midX + 10, midY - 10);
            ctx.fillText(text, midX + 10, midY - 10);
        }

        // インデックス付きラベルを描画
        function drawIndexLabel(point1, point2, index, color) {
            const midX = (point1.x + point2.x) / 2;
            const midY = (point1.y + point2.y) / 2;
            
            // 円形の背景
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(midX, midY, 20, 0, 2 * Math.PI);
            ctx.fill();
            
            // 白い縁
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // インデックス番号
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(`${index}`, midX, midY);
            
            // テキスト設定をリセット
            ctx.textAlign = 'start';
            ctx.textBaseline = 'alphabetic';
        }

        // キャンバスクリック処理
        function handleCanvasClick(event) {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            if (measurementStep === 0) {
                // 基準線の設定
                referencePoints.push({x, y});
                if (referencePoints.length === 2) {
                    referencePixels = calculateDistance(referencePoints[0], referencePoints[1]);
                    measurementStep = 1;
                    updateMeasurementInstructions();
                }
            } else if (measurementStep === 1) {
                // 測定線の設定
                measurementPoints.push({x, y});
                if (measurementPoints.length === 2) {
                    const measurementPixels = calculateDistance(measurementPoints[0], measurementPoints[1]);
                    const referenceLength = parseFloat(document.getElementById('referenceLength').value);
                    const actualLength = (measurementPixels / referencePixels) * referenceLength;
                    const unit = document.getElementById('unit').value;
                    
                    showMeasurementResult(actualLength.toFixed(1), unit);
                }
            }
            
            drawCanvas();
        }

        // 距離計算
        function calculateDistance(point1, point2) {
            return Math.sqrt(Math.pow(point2.x - point1.x, 2) + Math.pow(point2.y - point1.y, 2));
        }

        // 測定指示更新
        function updateMeasurementInstructions() {
            const title = document.getElementById('measurementTitle');
            const instruction = document.getElementById('measurementInstruction');
            
            if (measurementStep === 0) {
                title.textContent = 'ものさしの両はしをクリック';
                instruction.textContent = 'ものさしの始まりと終わりを順番にクリックしてね';
                document.getElementById('referenceSetup').style.display = 'block';
            } else if (measurementStep === 1) {
                const currentIndex = photoAnnotations[currentPhotoType].length + 1;
                const target = currentPhotoType === 'leaf' ? '葉っぱや花' : '茎';
                title.textContent = `${target}の測定 ②${currentIndex}`;
                instruction.textContent = `測りたい場所の始まりと終わりを順番にクリックしてね`;
                document.getElementById('referenceSetup').style.display = 'none';
            }
        }

        // 測定結果表示
        function showMeasurementResult(value, unit) {
            const resultDiv = document.getElementById('measurementResult');
            const resultTitle = document.getElementById('resultTitle');
            const resultValue = document.getElementById('resultValue');
            
            const currentIndex = photoAnnotations[currentPhotoType].length + 1;
            const target = currentPhotoType === 'leaf' ? '葉っぱ' : '茎';
            resultTitle.textContent = `${target}の測定 ②${currentIndex}`;
            resultValue.textContent = `${value} ${unit}`;
            
            resultDiv.style.display = 'block';
        }

        // 別の測定を追加
        function addAnotherMeasurement() {
            // 現在の測定を保存
            saveMeasurement();
            
            // 新しい測定を開始
            measurementStep = 1;
            measurementPoints = [];
            updateMeasurementInstructions();
            document.getElementById('measurementResult').style.display = 'none';
        }

        // 測定を保存
        function saveMeasurement() {
            if (measurementPoints.length === 2) {
                const measurementPixels = calculateDistance(measurementPoints[0], measurementPoints[1]);
                const referenceLength = parseFloat(document.getElementById('referenceLength').value);
                const actualLength = (measurementPixels / referencePixels) * referenceLength;
                const unit = document.getElementById('unit').value;
                
                const currentIndex = photoAnnotations[currentPhotoType].length + 1;
                const color = markerColors[(currentIndex - 1) % markerColors.length];
                
                // 測定マーカーを保存
                const annotation = {
                    points: [...measurementPoints],
                    index: currentIndex,
                    color: color,
                    value: actualLength.toFixed(1),
                    unit: unit
                };
                photoAnnotations[currentPhotoType].push(annotation);
                
                // 測定結果を保存
                const measurement = {
                    index: currentIndex,
                    value: actualLength.toFixed(1),
                    unit: unit,
                    color: color
                };
                
                if (currentPhotoType === 'leaf') {
                    leafMeasurements.push(measurement);
                } else {
                    stemMeasurements.push(measurement);
                }
                
                updateMeasurementResults(currentPhotoType);
            }
        }

        // すべての測定完了
        function finishAllMeasurements() {
            // 最後の測定を保存
            saveMeasurement();
            
            // 写真にマーカーを追加して再表示
            updatePhotoWithAnnotations(currentPhotoType);
            
            document.getElementById('measurementArea').style.display = 'none';
            canvas.removeEventListener('click', handleCanvasClick);
        }

        // 写真にマーカーを追加
        function updatePhotoWithAnnotations(type) {
            const img = new Image();
            img.onload = function() {
                const annotationCanvas = document.createElement('canvas');
                const annotationCtx = annotationCanvas.getContext('2d');
                
                annotationCanvas.width = img.width;
                annotationCanvas.height = img.height;
                
                // 元の画像を描画
                annotationCtx.drawImage(img, 0, 0);
                
                // マーカーを描画
                photoAnnotations[type].forEach((annotation) => {
                    const scaleX = img.width / canvas.width;
                    const scaleY = img.height / canvas.height;
                    
                    const point1 = {
                        x: annotation.points[0].x * scaleX,
                        y: annotation.points[0].y * scaleY
                    };
                    const point2 = {
                        x: annotation.points[1].x * scaleX,
                        y: annotation.points[1].y * scaleY
                    };
                    
                    // 測定線を描画
                    annotationCtx.strokeStyle = annotation.color;
                    annotationCtx.lineWidth = 6;
                    annotationCtx.beginPath();
                    annotationCtx.moveTo(point1.x, point1.y);
                    annotationCtx.lineTo(point2.x, point2.y);
                    annotationCtx.stroke();
                    
                    // 測定点を描画
                    annotationCtx.fillStyle = annotation.color;
                    annotationCtx.beginPath();
                    annotationCtx.arc(point1.x, point1.y, 12, 0, 2 * Math.PI);
                    annotationCtx.fill();
                    annotationCtx.beginPath();
                    annotationCtx.arc(point2.x, point2.y, 12, 0, 2 * Math.PI);
                    annotationCtx.fill();
                    
                    // インデックス付きラベルを描画
                    const midX = (point1.x + point2.x) / 2;
                    const midY = (point1.y + point2.y) / 2;
                    
                    // 円形の背景
                    annotationCtx.fillStyle = annotation.color;
                    annotationCtx.beginPath();
                    annotationCtx.arc(midX, midY, 30, 0, 2 * Math.PI);
                    annotationCtx.fill();
                    
                    // 白い縁
                    annotationCtx.strokeStyle = 'white';
                    annotationCtx.lineWidth = 4;
                    annotationCtx.stroke();
                    
                    // インデックス番号
                    annotationCtx.fillStyle = 'white';
                    annotationCtx.font = 'bold 24px Arial';
                    annotationCtx.textAlign = 'center';
                    annotationCtx.textBaseline = 'middle';
                    annotationCtx.fillText(`${annotation.index}`, midX, midY);
                });
                
                // 注釈付き画像を保存
                photos[type] = annotationCanvas.toDataURL('image/jpeg', 0.8);
                displayPhoto(type, photos[type]);
            };
            img.src = photos[type];
        }

        // 測定結果更新
        function updateMeasurementResults(type) {
            const resultsList = document.getElementById(type + 'ResultsList');
            const resultsDiv = document.getElementById(type + 'MeasurementResults');
            
            const measurements = type === 'leaf' ? leafMeasurements : stemMeasurements;
            
            if (measurements.length === 0) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            resultsDiv.style.display = 'block';
            
            let html = '';
            measurements.forEach((measurement, index) => {
                html += `
                    <div class="result-item">
                        <div class="result-info">
                            <div class="result-name" style="color: ${measurement.color}">②${measurement.index} 測定結果</div>
                        </div>
                        <div class="result-value">${measurement.value} ${measurement.unit}</div>
                        <button class="delete-result" onclick="deleteMeasurement('${type}', ${index})">削除</button>
                    </div>
                `;
            });
            
            resultsList.innerHTML = html;
        }

        // 測定削除
        function deleteMeasurement(type, index) {
            if (confirm('この測定結果を削除しますか？')) {
                if (type === 'leaf') {
                    leafMeasurements.splice(index, 1);
                } else {
                    stemMeasurements.splice(index, 1);
                }
                photoAnnotations[type].splice(index, 1);
                updateMeasurementResults(type);
                updatePhotoWithAnnotations(type);
            }
        }

        // 成長記録を保存
        function saveGrowthRecords() {
            localStorage.setItem('plantGrowthRecords', JSON.stringify(growthRecords));
        }

        // ローカルストレージから成長記録を読み込み
        function loadGrowthRecords() {
            const saved = localStorage.getItem('plantGrowthRecords');
            if (saved) {
                growthRecords = JSON.parse(saved);
            }
        }

        // 今日の記録を保存
        function saveGrowthRecord() {
            const plantName = document.getElementById('plantName').value.trim();
            const observationDate = document.getElementById('observationDate').value;
            const weather = document.getElementById('weather').value;
            
            if (!plantName || !observationDate || leafMeasurements.length === 0 || stemMeasurements.length === 0) {
                alert('植物の名前、日付、測定結果を入力してから保存してください。');
                return;
            }
            
            const record = {
                id: Date.now(),
                plantName: plantName,
                date: observationDate,
                weather: weather,
                leafMeasurements: [...leafMeasurements],
                stemMeasurements: [...stemMeasurements],
                observation: document.getElementById('observationText').value.trim(),
                photos: {
                    leaf: photos.leaf,
                    stem: photos.stem
                }
            };
            
            // 同じ日付の記録があるかチェック
            const existingIndex = growthRecords.findIndex(r => r.date === observationDate && r.plantName === plantName);
            if (existingIndex >= 0) {
                if (confirm('同じ日付の記録があります。上書きしますか？')) {
                    growthRecords[existingIndex] = record;
                } else {
                    return;
                }
            } else {
                growthRecords.push(record);
            }
            
            // 日付順にソート（新しい順）
            growthRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            saveGrowthRecords();
            alert('成長記録を保存しました！');
            
            // 比較を表示
            showGrowthComparison();
        }

        // 成長履歴を表示
        function showGrowthHistory() {
            const historyDiv = document.getElementById('growthHistory');
            const recordsDiv = document.getElementById('growthRecords');
            
            if (growthRecords.length === 0) {
                recordsDiv.innerHTML = '<p style="text-align: center; color: #666;">まだ記録がありません</p>';
            } else {
                let html = '';
                growthRecords.forEach((record, index) => {
                    html += `
                        <div class="growth-record">
                            <div class="growth-date">${record.date} (${record.weather}) - ${record.plantName}</div>
                            <div class="growth-measurements">
                    `;
                    
                    record.leafMeasurements.forEach(measurement => {
                        html += `
                            <div class="growth-measurement">
                                <div style="color: ${measurement.color};">葉②${measurement.index}</div>
                                <div class="growth-value">${measurement.value}${measurement.unit}</div>
                            </div>
                        `;
                    });
                    
                    record.stemMeasurements.forEach(measurement => {
                        html += `
                            <div class="growth-measurement">
                                <div style="color: ${measurement.color};">茎②${measurement.index}</div>
                                <div class="growth-value">${measurement.value}${measurement.unit}</div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                            ${record.observation ? `<div style="margin-top: 8px; font-style: italic; color: #666;">"${record.observation}"</div>` : ''}
                            <button class="delete-record" onclick="deleteGrowthRecord(${index})">削除</button>
                        </div>
                    `;
                });
                recordsDiv.innerHTML = html;
            }
            
            historyDiv.style.display = historyDiv.style.display === 'none' ? 'block' : 'none';
        }

        // 成長記録を削除
        function deleteGrowthRecord(index) {
            if (confirm('この記録を削除しますか？')) {
                growthRecords.splice(index, 1);
                saveGrowthRecords();
                showGrowthHistory();
                showGrowthComparison();
            }
        }

        // 成長比較を表示
        function showGrowthComparison() {
            const comparisonDiv = document.getElementById('growthComparison');
            const resultsDiv = document.getElementById('comparisonResults');
            
            if (growthRecords.length < 2) {
                comparisonDiv.style.display = 'none';
                return;
            }
            
            const currentPlant = document.getElementById('plantName').value.trim();
            const plantRecords = growthRecords.filter(r => r.plantName === currentPlant);
            
            if (plantRecords.length < 2) {
                comparisonDiv.style.display = 'none';
                return;
            }
            
            const latest = plantRecords[0];
            const previous = plantRecords[1];
            
            let html = `<div style="text-align: center; margin-bottom: 10px; color: #666;">
                ${previous.date} → ${latest.date} の変化
            </div>`;
            
            // 葉の比較
            latest.leafMeasurements.forEach((current, index) => {
                if (previous.leafMeasurements[index]) {
                    const prev = previous.leafMeasurements[index];
                    const change = parseFloat(current.value) - parseFloat(prev.value);
                    const changeClass = change > 0 ? 'growth-positive' : change < 0 ? 'growth-negative' : 'growth-neutral';
                    const changeText = change > 0 ? `+${change.toFixed(1)}${current.unit}` : 
                                     change < 0 ? `${change.toFixed(1)}${current.unit}` : '変化なし';
                    
                    html += `
                        <div class="comparison-item">
                            <span class="comparison-label" style="color: ${current.color};">葉②${current.index}</span>
                            <span class="comparison-change ${changeClass}">${changeText}</span>
                        </div>
                    `;
                }
            });
            
            // 茎の比較
            latest.stemMeasurements.forEach((current, index) => {
                if (previous.stemMeasurements[index]) {
                    const prev = previous.stemMeasurements[index];
                    const change = parseFloat(current.value) - parseFloat(prev.value);
                    const changeClass = change > 0 ? 'growth-positive' : change < 0 ? 'growth-negative' : 'growth-neutral';
                    const changeText = change > 0 ? `+${change.toFixed(1)}${current.unit}` : 
                                     change < 0 ? `${change.toFixed(1)}${current.unit}` : '変化なし';
                    
                    html += `
                        <div class="comparison-item">
                            <span class="comparison-label" style="color: ${current.color};">茎②${current.index}</span>
                            <span class="comparison-change ${changeClass}">${changeText}</span>
                        </div>
                    `;
                }
            });
            
            resultsDiv.innerHTML = html;
            comparisonDiv.style.display = 'block';
        }

        // 履歴をクリア
        function clearGrowthHistory() {
            if (confirm('すべての成長記録を削除しますか？この操作は取り消せません。')) {
                growthRecords = [];
                saveGrowthRecords();
                document.getElementById('growthHistory').style.display = 'none';
                document.getElementById('growthComparison').style.display = 'none';
                alert('成長記録をクリアしました。');
            }
        }

        // フォーム完成チェック
        function checkFormCompletion() {
            const plantName = document.getElementById('plantName').value.trim();
            const observationDate = document.getElementById('observationDate').value;
            const weather = document.getElementById('weather').value;
            const observationText = document.getElementById('observationText').value.trim();
            
            const hasPhotos = photos.leaf && photos.stem;
            const hasMeasurements = leafMeasurements.length > 0 && stemMeasurements.length > 0;
            
            const isComplete = plantName && observationDate && weather && observationText && hasPhotos && hasMeasurements;
            
            document.getElementById('printBtn').disabled = !isComplete;
            document.getElementById('saveGrowthBtn').disabled = !isComplete;
        }

        // 印刷処理
        function printRecord() {
            // 基本情報設定
            document.getElementById('printPlantName').textContent = document.getElementById('plantName').value;
            document.getElementById('printDate').textContent = document.getElementById('observationDate').value;
            document.getElementById('printWeather').textContent = document.getElementById('weather').value;
            document.getElementById('printObservation').textContent = document.getElementById('observationText').value;
            
            // 写真設定（マーカー付き）
            if (photos.leaf) {
                document.getElementById('printLeafPhoto').innerHTML = `<img src="${photos.leaf}" alt="葉っぱの写真">`;
            }
            if (photos.stem) {
                document.getElementById('printStemPhoto').innerHTML = `<img src="${photos.stem}" alt="茎の写真">`;
            }
            
            // 詳細測定結果設定
            let allMeasurements = '';
            leafMeasurements.forEach(measurement => {
                allMeasurements += `葉②${measurement.index}: ${measurement.value}${measurement.unit} / `;
            });
            stemMeasurements.forEach(measurement => {
                allMeasurements += `茎②${measurement.index}: ${measurement.value}${measurement.unit} / `;
            });
            
            // 末尾の " / " を削除
            allMeasurements = allMeasurements.replace(/ \/ $/, '');
            
            document.getElementById('printMeasurements').innerHTML = allMeasurements || '測定結果がありません';
            
            // 成長記録を印刷用に設定
            const currentPlant = document.getElementById('plantName').value.trim();
            const plantRecords = growthRecords.filter(r => r.plantName === currentPlant);
            
            let growthHtml = '';
            if (plantRecords.length > 1) {
                const latest = plantRecords[0];
                const previous = plantRecords[1];
                
                growthHtml += `前回記録: ${previous.date} → 今回記録: ${latest.date}<br>`;
                
                latest.leafMeasurements.forEach((current, index) => {
                    if (previous.leafMeasurements[index]) {
                        const prev = previous.leafMeasurements[index];
                        const change = parseFloat(current.value) - parseFloat(prev.value);
                        const changeText = change > 0 ? `+${change.toFixed(1)}${current.unit}` : 
                                         change < 0 ? `${change.toFixed(1)}${current.unit}` : '変化なし';
                        growthHtml += `葉②${current.index}: ${prev.value}${prev.unit} → ${current.value}${current.unit} (${changeText})<br>`;
                    }
                });
                
                latest.stemMeasurements.forEach((current, index) => {
                    if (previous.stemMeasurements[index]) {
                        const prev = previous.stemMeasurements[index];
                        const change = parseFloat(current.value) - parseFloat(prev.value);
                        const changeText = change > 0 ? `+${change.toFixed(1)}${current.unit}` : 
                                         change < 0 ? `${change.toFixed(1)}${current.unit}` : '変化なし';
                        growthHtml += `茎②${current.index}: ${prev.value}${prev.unit} → ${current.value}${current.unit} (${changeText})<br>`;
                    }
                });
            } else {
                growthHtml = '比較できる過去の記録がありません';
            }
            
            document.getElementById('printGrowthRecord').innerHTML = growthHtml;
            
            // 印刷実行
            document.getElementById('printContent').style.display = 'block';
            window.print();
            document.getElementById('printContent').style.display = 'none';
        }
    </script>
</body>
</html>
